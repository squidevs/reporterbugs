<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciador de Traduções</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>Gerenciador de Traduções</h1>
        
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Importar Traduções
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="countrySelect" class="form-label">País</label>
                            <select class="form-select" id="countrySelect">
                                <option value="AR">Argentina (AR)</option>
                                <option value="PE">Peru (PE)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="jsonFile" class="form-label">Arquivo JSON</label>
                            <input type="file" class="form-control" id="jsonFile" accept=".json">
                        </div>
                        <button onclick="importJSON()" class="btn btn-primary">Importar</button>
                        <button onclick="clearData()" class="btn btn-danger">Limpar Dados</button>
                    </div>
                </div>

                <div class="card mt-3">
                    <div class="card-header">
                        Status
                    </div>
                    <div class="card-body">
                        <div id="arStatus" class="alert alert-secondary">
                            AR: Não carregado
                        </div>
                        <div id="peStatus" class="alert alert-secondary">
                            PE: Não carregado
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h3>Traduções</h3>
                    <button onclick="exportToCSV()" class="btn btn-success">
                        <i class="bi bi-file-earmark-excel"></i> Exportar CSV
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-bordered">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Grouping</th>
                                <th>Referring Key</th>
                                <th>Argentina (AR)</th>
                                <th>Peru (PE)</th>
                            </tr>
                        </thead>
                        <tbody id="translationsTable">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Função para achatar objeto mantendo a ordem
        function processTranslations(obj) {
            let result = [];
            let groupMap = new Map(); // Mapa para controlar grupos e suas contagens

            function processGroup(group, data, parentPath = '') {
                if (!groupMap.has(group)) {
                    groupMap.set(group, {
                        count: 0,
                        groupNumber: groupMap.size + 1
                    });
                }

                const groupInfo = groupMap.get(group);

                for (let key in data) {
                    const value = data[key];
                    if (value !== null && typeof value === 'object' && !Array.isArray(value)) {
                        // É um objeto aninhado, processa recursivamente
                        processGroup(key, value, key);
                    } else {
                        // É um valor final
                        groupInfo.count++;
                        result.push({
                            id: `G${groupInfo.groupNumber}L${groupInfo.count}`,
                            group: group,
                            key: key,
                            fullPath: parentPath ? `${parentPath}.${key}` : key,
                            value: value
                        });
                    }
                }
            }

            // Processa o objeto raiz
            for (let topGroup in obj) {
                processGroup(topGroup, obj[topGroup]);
            }

            return result;
        }

        // Função para importar JSON
        async function importJSON() {
            const fileInput = document.getElementById('jsonFile');
            const countrySelect = document.getElementById('countrySelect');
            const country = countrySelect.value;

            if (!fileInput.files.length) {
                alert('Por favor, selecione um arquivo JSON');
                return;
            }

            try {
                const file = fileInput.files[0];
                const text = await file.text();
                const data = JSON.parse(text);

                // Recuperar dados existentes
                let translations = JSON.parse(localStorage.getItem('translations') || '{"AR":null,"PE":null}');
                
                // Atualizar dados do país selecionado
                translations[country] = data;
                
                // Salvar no localStorage
                localStorage.setItem('translations', JSON.stringify(translations));
                
                // Atualizar status e tabela
                updateStatus();
                displayTranslations();
                
                alert('Arquivo importado com sucesso!');
                fileInput.value = ''; // Limpar input
            } catch (error) {
                console.error('Erro ao importar:', error);
                alert('Erro ao importar o arquivo. Verifique se é um JSON válido.');
            }
        }

        // Função para limpar dados
        function clearData() {
            if (confirm('Tem certeza que deseja limpar todos os dados?')) {
                localStorage.removeItem('translations');
                updateStatus();
                displayTranslations();
                alert('Dados limpos com sucesso!');
            }
        }

        // Função para atualizar status
        function updateStatus() {
            const translations = JSON.parse(localStorage.getItem('translations') || '{"AR":null,"PE":null}');
            
            const arStatus = document.getElementById('arStatus');
            const peStatus = document.getElementById('peStatus');
            
            arStatus.className = translations.AR ? 'alert alert-success' : 'alert alert-secondary';
            arStatus.textContent = `AR: ${translations.AR ? 'Carregado' : 'Não carregado'}`;
            
            peStatus.className = translations.PE ? 'alert alert-success' : 'alert alert-secondary';
            peStatus.textContent = `PE: ${translations.PE ? 'Carregado' : 'Não carregado'}`;
        }

        // Função para exibir traduções
        function displayTranslations() {
            const translations = JSON.parse(localStorage.getItem('translations') || '{"AR":null,"PE":null}');
            const table = document.getElementById('translationsTable');
            table.innerHTML = '';

            if (!translations.AR && !translations.PE) return;

            // Processar traduções
            const arData = translations.AR ? processTranslations(translations.AR) : [];
            const peData = translations.PE ? processTranslations(translations.PE) : [];

            // Combinar dados mantendo a ordem
            const allTranslations = new Map();
            
            arData.forEach(item => {
                allTranslations.set(item.id, {
                    id: item.id,
                    group: item.group,
                    key: item.key,
                    ar: item.value,
                    pe: null,
                    fullPath: item.fullPath
                });
            });

            peData.forEach(item => {
                if (allTranslations.has(item.id)) {
                    allTranslations.get(item.id).pe = item.value;
                } else {
                    allTranslations.set(item.id, {
                        id: item.id,
                        group: item.group,
                        key: item.key,
                        ar: null,
                        pe: item.value,
                        fullPath: item.fullPath
                    });
                }
            });

            // Ordenar por ID
            const sortedTranslations = Array.from(allTranslations.values())
                .sort((a, b) => {
                    const [aG, aL] = a.id.match(/G(\d+)L(\d+)/).slice(1).map(Number);
                    const [bG, bL] = b.id.match(/G(\d+)L(\d+)/).slice(1).map(Number);
                    return aG !== bG ? aG - bG : aL - bL;
                });

            // Criar linhas da tabela
            sortedTranslations.forEach(item => {
                const row = table.insertRow();
                row.insertCell(0).textContent = item.id;
                row.insertCell(1).textContent = item.group;
                row.insertCell(2).textContent = item.fullPath || item.key;
                row.insertCell(3).textContent = item.ar || '';
                row.insertCell(4).textContent = item.pe || '';
            });
        }

        // Função para exportar para CSV
        function exportToCSV() {
            const translations = JSON.parse(localStorage.getItem('translations') || '{"AR":null,"PE":null}');
            if (!translations.AR && !translations.PE) {
                alert('Nenhum dado para exportar');
                return;
            }

            const arData = translations.AR ? processTranslations(translations.AR) : [];
            const peData = translations.PE ? processTranslations(translations.PE) : [];

            // Combinar dados mantendo a ordem
            const allTranslations = new Map();
            
            arData.forEach(item => {
                allTranslations.set(item.id, {
                    id: item.id,
                    group: item.group,
                    key: item.key,
                    ar: item.value,
                    pe: null,
                    fullPath: item.fullPath
                });
            });

            peData.forEach(item => {
                if (allTranslations.has(item.id)) {
                    allTranslations.get(item.id).pe = item.value;
                } else {
                    allTranslations.set(item.id, {
                        id: item.id,
                        group: item.group,
                        key: item.key,
                        ar: null,
                        pe: item.value,
                        fullPath: item.fullPath
                    });
                }
            });

            // Ordenar por ID e criar CSV
            const sortedTranslations = Array.from(allTranslations.values())
                .sort((a, b) => {
                    const [aG, aL] = a.id.match(/G(\d+)L(\d+)/).slice(1).map(Number);
                    const [bG, bL] = b.id.match(/G(\d+)L(\d+)/).slice(1).map(Number);
                    return aG !== bG ? aG - bG : aL - bL;
                });

            let csv = 'ID;Grouping;Referring Key;Argentina (AR);Peru (PE)\n';
            sortedTranslations.forEach(item => {
                csv += `"${item.id}";"${item.group}";"${item.fullPath || item.key}";"${(item.ar || '').replace(/"/g, '""')}";"${(item.pe || '').replace(/"/g, '""')}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'traducoes.csv';
            link.click();
        }

        // Inicializar
        updateStatus();
        displayTranslations();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
